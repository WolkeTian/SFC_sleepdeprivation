function [dFC_var, dFC_avg] = compute_dFC_variability(time_series, window_size)
% 计算动态功能连接变异性
% 输入：
%   time_series : T x N 矩阵，T为TR数，N为脑区数
%   window_size : 滑动窗口长度，单位为 TR（推荐30）
%
% 输出：
%   dFC_var : N x N 矩阵，每对脑区之间的FC标准差（dFC变异性）
%   dFC_avg : 所有上三角边的平均dFC变异性（标量）

if nargin < 2
    window_size = 30;  % 默认窗口长度
end

step_size = 1;  % 步长为1 TR
[T, N] = size(time_series);
n_windows = floor((T - window_size) / step_size) + 1;

FC_all = zeros(N, N, n_windows);

% 滑窗计算功能连接
for w = 1:n_windows
    idx = (w - 1) * step_size + (1:window_size);
    ts_win = time_series(idx, :);  % 当前窗口的时间序列
    FC_win = corr(ts_win);         % N x N 功能连接矩阵
    FC_all(:, :, w) = FC_win;
end

% 每对脑区连接 across windows 的标准差
dFC_var = std(FC_all, 0, 3);  % N x N，dFC 变异性矩阵

% 平均上三角边（不含对角线）的变异性
mask = triu(true(N), 1);
dFC_avg = mean(dFC_var(mask));

end
